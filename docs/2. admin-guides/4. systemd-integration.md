# Systemd Integration Guide

Running KohakuRiver Host and Runner as systemd services ensures reliable operation, automatic startup on boot, and proper service management in production environments.

---

## Overview

### What Systemd Provides

| Feature | Description |
|---------|-------------|
| **Auto-start** | Services start automatically on boot |
| **Restart on failure** | Automatic recovery from crashes |
| **Logging** | Centralized logging via journald |
| **Dependency management** | Start after network and Docker |
| **Resource control** | Basic resource limits for services |

---

## Quick Start

### Generate and Install Services

```bash
# Generate and register both services
kohakuriver init service --all

# Or individually
kohakuriver init service --host
kohakuriver init service --runner
```

This command:
1. Creates service files in a temp directory
2. Copies them to `/etc/systemd/system/`
3. Reloads the systemd daemon

### Start and Enable

```bash
# Start service
sudo systemctl start kohakuriver-host
sudo systemctl start kohakuriver-runner

# Enable on boot
sudo systemctl enable kohakuriver-host
sudo systemctl enable kohakuriver-runner
```

---

## Service Generation Options

```bash
kohakuriver init service [OPTIONS]
```

| Option | Description |
|--------|-------------|
| `--host` | Create Host service only |
| `--runner` | Create Runner service only |
| `--all` | Create both services |
| `--host-config PATH` | Custom host config path |
| `--runner-config PATH` | Custom runner config path |
| `--working-dir DIR` | Working directory (default: `~/.kohakuriver`) |
| `--no-install` | Generate files only, don't register |

### Generate Without Installing

```bash
# Generate files to current directory
kohakuriver init service --all --no-install

# Review generated files
cat kohakuriver-host.service
cat kohakuriver-runner.service

# Manual installation
sudo cp kohakuriver-*.service /etc/systemd/system/
sudo systemctl daemon-reload
```

---

## Generated Service Files

### Host Service

```ini
[Unit]
Description=KohakuRiver Host Server
After=network.target

[Service]
Type=simple
User=<your_username>
Group=<your_group>
WorkingDirectory=/home/<your_username>/.kohakuriver
ExecStart=/path/to/python -m kohakuriver.cli.host
Restart=on-failure
RestartSec=5
Environment="PATH=/path/to/venv/bin:/usr/bin:..."

[Install]
WantedBy=multi-user.target
```

### Runner Service

```ini
[Unit]
Description=KohakuRiver Runner Agent
After=network.target docker.service
Wants=docker.service

[Service]
Type=simple
User=<your_username>
Group=<your_group>
WorkingDirectory=/home/<your_username>/.kohakuriver
ExecStart=/path/to/python -m kohakuriver.cli.runner
Restart=on-failure
RestartSec=5
Environment="PATH=/path/to/venv/bin:/usr/bin:..."

[Install]
WantedBy=multi-user.target
```

---

## Service Management

### Common Commands

| Action | Command |
|--------|---------|
| **Start** | `sudo systemctl start kohakuriver-host` |
| **Stop** | `sudo systemctl stop kohakuriver-host` |
| **Restart** | `sudo systemctl restart kohakuriver-host` |
| **Status** | `sudo systemctl status kohakuriver-host` |
| **Enable on boot** | `sudo systemctl enable kohakuriver-host` |
| **Disable on boot** | `sudo systemctl disable kohakuriver-host` |

### Viewing Logs

```bash
# View all logs
journalctl -u kohakuriver-host

# Follow logs in real-time
journalctl -u kohakuriver-runner -f

# Logs since service start
journalctl -u kohakuriver-host --since "service start"

# Logs from last hour
journalctl -u kohakuriver-runner --since "1 hour ago"

# Show specific number of lines
journalctl -u kohakuriver-host -n 100
```

---

## Customization

### Using systemctl edit

Customize services without modifying the original files:

```bash
sudo systemctl edit kohakuriver-host.service
```

This creates an override file at `/etc/systemd/system/kohakuriver-host.service.d/override.conf`.

### Common Customizations

**Add resource limits:**

```ini
[Service]
CPUQuota=200%
MemoryMax=4G
```

**Run as dedicated user:**

```ini
[Service]
User=kohakuriver
Group=kohakuriver
```

**Add dependencies:**

```ini
[Unit]
After=network-online.target docker.service
Requires=docker.service
```

**Custom environment:**

```ini
[Service]
Environment="LOG_LEVEL=DEBUG"
EnvironmentFile=/etc/kohakuriver/environment
```

### Apply Changes

After editing, reload and restart:

```bash
sudo systemctl daemon-reload
sudo systemctl restart kohakuriver-host
```

---

## Dedicated Service User

For production deployments, run services under a dedicated user:

### Create System User

```bash
# Create user for host
sudo useradd --system --no-create-home --shell /sbin/nologin kohakuriver-host

# Create user for runner (needs docker group access)
sudo useradd --system --no-create-home --shell /sbin/nologin kohakuriver-runner
sudo usermod -aG docker kohakuriver-runner
```

### Update Service File

```ini
[Service]
User=kohakuriver-runner
Group=kohakuriver-runner
```

### Set Permissions

```bash
# Config directory
sudo chown -R kohakuriver-host:kohakuriver-host ~/.kohakuriver/
sudo chmod 700 ~/.kohakuriver/

# Database directory (host only)
sudo chown kohakuriver-host:kohakuriver-host /var/lib/kohakuriver/
sudo chmod 750 /var/lib/kohakuriver/
```

---

## Multiple Runners on One Machine

For multiple runner instances on a single node:

### Create Separate Configs

```bash
# Generate configs with different ports
kohakuriver init config --runner -o ~/.kohakuriver/runner1/
kohakuriver init config --runner -o ~/.kohakuriver/runner2/
```

Edit each config to use different ports:
- Runner 1: `RUNNER_PORT = 8001`
- Runner 2: `RUNNER_PORT = 8011`

### Generate Services

```bash
# Generate with --no-install to get files
kohakuriver init service --runner --runner-config ~/.kohakuriver/runner1/runner_config.py --no-install
mv kohakuriver-runner.service kohakuriver-runner1.service

kohakuriver init service --runner --runner-config ~/.kohakuriver/runner2/runner_config.py --no-install
mv kohakuriver-runner.service kohakuriver-runner2.service

# Install both
sudo cp kohakuriver-runner*.service /etc/systemd/system/
sudo systemctl daemon-reload
```

### Start Both

```bash
sudo systemctl enable --now kohakuriver-runner1
sudo systemctl enable --now kohakuriver-runner2
```

---

## Troubleshooting

| Issue | Solution |
|-------|----------|
| Service won't start | Check `journalctl -u <service> -e` for errors |
| Permission denied | Verify user has access to config, Docker, shared storage |
| Config not found | Use absolute paths in `--host-config` / `--runner-config` |
| Docker not available | Add `Requires=docker.service` to dependencies |
| Network not ready | Use `After=network-online.target` |

### Debug Commands

```bash
# Check service status
sudo systemctl status kohakuriver-host

# View service file locations
systemctl show kohakuriver-host --property=FragmentPath

# Check if enabled
systemctl is-enabled kohakuriver-host

# List all KohakuRiver services
systemctl list-units 'kohakuriver*'
```

---

## Best Practices

| Practice | Description |
|----------|-------------|
| **Dedicated users** | Run under system accounts, not personal users |
| **Enable on boot** | Use `systemctl enable` for auto-start |
| **Log rotation** | journald handles this automatically |
| **Resource limits** | Set `CPUQuota` and `MemoryMax` for services |
| **Monitor status** | Regularly check `systemctl status` |

---

## Next Steps

1. [Review security considerations](5.%20security.md)
2. Set up monitoring for service health
3. Configure log forwarding if needed
