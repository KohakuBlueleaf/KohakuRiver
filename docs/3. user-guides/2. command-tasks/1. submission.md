# Command Task Submission Guide

This guide explains how to submit, manage, and monitor command-line tasks in KohakuRiver.

---

## Basic Syntax

```bash
kohakuriver task submit <command> [args...] [OPTIONS]
```

| Component | Description |
|-----------|-------------|
| `<command>` | The command to execute |
| `[args...]` | Command arguments (optional) |
| `[OPTIONS]` | Task options (target, resources, etc.) |

---

## Quick Start

### Simple Task

```bash
kohakuriver task submit "echo Hello, KohakuRiver!" -t node1
```

### Task with Arguments

```bash
kohakuriver task submit "python /shared/script.py" --input data.csv --output results.json -t node1
```

---

## Target Selection

### Basic Targeting

Use `--target` or `-t` to specify where to run:

```bash
kohakuriver task submit "hostname" -t node1
```

### Target Syntax

```
HOST[:NUMA_ID][::GPU_ID1,GPU_ID2,...]
```

| Component | Description |
|-----------|-------------|
| `HOST` | Runner hostname (required) |
| `:NUMA_ID` | NUMA node ID (optional) |
| `::GPU_IDs` | GPU device IDs (optional) |

### Examples

```bash
# Run on node1
kohakuriver task submit "hostname" -t node1

# Run on NUMA node 0 of node1
kohakuriver task submit "numactl --hardware" -t node1:0

# Run with GPUs 0 and 1 on node3
kohakuriver task submit "python train.py" -t node3::0,1 --container my-cuda-env

# Run on multiple nodes (creates separate tasks)
kohakuriver task submit "hostname" -t node1 -t node2 -t node3
```

---

## Resource Allocation

### CPU Cores

```bash
kohakuriver task submit "python compute.py" -t node1 --cores 4
```

### Memory Limit

```bash
kohakuriver task submit "python memory_heavy.py" -t node1 --memory 8G
```

Memory units: `K` (kilobytes), `M` (megabytes), `G` (gigabytes)

### Combined Resources

```bash
kohakuriver task submit "python heavy_task.py" -t node3::0,1 \
  --cores 8 --memory 16G --container my-cuda-env
```

---

## Container Environment

### Specify Container

```bash
kohakuriver task submit "python /shared/script.py" -t node1 --container my-python-env
```

### Use Default Container

If `--container` is omitted, the Host's default container is used:

```bash
kohakuriver task submit "python /shared/script.py" -t node1
```

---

## Task Options Reference

| Option | Short | Description |
|--------|-------|-------------|
| `--target` | `-t` | Target node[:numa][::gpus] |
| `--cores` | `-c` | CPU cores (default: 1) |
| `--memory` | `-m` | Memory limit (e.g., 4G) |
| `--container` | | Container environment name |
| `--privileged` | | Run with Docker --privileged |
| `--mount` | | Additional mounts (repeatable) |
| `--wait` | `-w` | Wait for task completion |

---

## Additional Options

### Additional Mounts

Mount extra host directories:

```bash
kohakuriver task submit "ls /mnt/data" -t node1 \
  --mount /data/input:/mnt/data
```

### Privileged Mode

For tasks requiring extended permissions:

```bash
kohakuriver task submit "docker info" -t node1 --privileged
```

**Use with caution** - grants extensive host access.

### Wait for Completion

Block until task finishes:

```bash
kohakuriver task submit "python long_task.py" -t node1 --wait
```

---

## Task Management

### List Tasks

```bash
# All tasks
kohakuriver task list

# Filter by status
kohakuriver task list --status running

# Filter by node
kohakuriver task list --node node1

# Compact output
kohakuriver task list --compact
```

### Check Status

```bash
kohakuriver task status <task_id>
```

Shows command, status, timestamps, exit code, and resource usage.

### View Logs

```bash
# View task output
kohakuriver task logs <task_id>
```

### Kill Task

```bash
kohakuriver task kill <task_id>
```

### Pause/Resume

```bash
kohakuriver task pause <task_id>
kohakuriver task resume <task_id>
```

### Watch Task

Monitor task output in real-time:

```bash
kohakuriver task watch <task_id>
```

---

## Batch Submission

### Multiple Targets

Submit the same task to multiple nodes:

```bash
kohakuriver task submit "hostname" -t node1 -t node2 -t node3
```

Creates three separate tasks.

### Scripted Submission

```bash
for node in node1 node2 node3; do
  kohakuriver task submit "python /shared/process.py --id $node" -t $node
done
```

---

## Examples

### Data Processing

```bash
kohakuriver task submit "python /shared/process_data.py" \
  --input /shared/data.csv \
  --output /shared/results.json \
  -t nodeA --cores 4 --memory 8G --container python-data-science
```

### GPU Training

```bash
kohakuriver task submit "python /shared/train_model.py" \
  -t nodeC::0,1 --cores 8 --memory 16G --container my-gpu-env
```

### Simple Commands

```bash
# Check disk space across nodes
kohakuriver task submit "df -h" -t node1 -t node2 -t node3

# Run tests
kohakuriver task submit "pytest /shared/tests/" -t node1 --container my-test-env --wait
```

---

## Task Lifecycle

```
┌──────────┐    ┌───────────┐    ┌─────────┐    ┌───────────┐
│ PENDING  │───>│ ASSIGNING │───>│ RUNNING │───>│ COMPLETED │
└──────────┘    └───────────┘    └─────────┘    └───────────┘
                                      │               │
                                      ▼               │
                                 ┌─────────┐          │
                                 │ PAUSED  │──────────┤
                                 └─────────┘          │
                                      │               │
                                      ▼               ▼
                                 ┌─────────┐    ┌─────────┐
                                 │ KILLED  │    │ FAILED  │
                                 └─────────┘    └─────────┘
```

| Status | Description |
|--------|-------------|
| `pending` | Waiting to be assigned |
| `assigning` | Being assigned to a Runner |
| `running` | Executing on a Runner |
| `paused` | Execution suspended |
| `completed` | Finished successfully (exit code 0) |
| `failed` | Finished with error (non-zero exit) |
| `killed` | Terminated by user request |
| `lost` | Runner lost contact during execution |

---

## Best Practices

| Practice | Description |
|----------|-------------|
| **Specify resources** | Always set `--cores` and `--memory` |
| **Use shared storage** | Place data/scripts in `/shared` |
| **Check logs** | Use `task logs` for debugging |
| **Use wait for scripts** | Add `--wait` when scripting |
| **Name containers clearly** | Use descriptive container names |

---

## Next Steps

1. [Best practices for command tasks](2.%20best-practices.md)
2. [VPS task management](../3.%20vps-tasks/1.%20management.md)
3. [GPU allocation](../4.%20gpu-allocation/1.%20allocation.md)
