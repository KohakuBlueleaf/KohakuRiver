# Accessing VPS Tasks

This guide explains the various methods to connect to VPS tasks.

---

## Access Methods Overview

KohakuRiver provides multiple ways to access VPS tasks:

| Method | Command | Requires SSH Server | Port Mapping |
|--------|---------|---------------------|--------------|
| **WebSocket Terminal** | `kohakuriver connect <id>` | No | Not needed |
| **IDE Mode** | `kohakuriver connect <id> --ide` | No | Not needed |
| **SSH Proxy** | `kohakuriver vps connect <id>` | Yes | Not needed |
| **Port Forwarding** | `kohakuriver forward <id> <port>` | No | Not needed |

> **Recommended**: Use `kohakuriver connect` for most use cases. It works without SSH server setup and provides full TTY support.

---

## WebSocket Terminal (Recommended)

Access your VPS with full TTY support, no SSH server required:

```bash
kohakuriver connect <task_id>
```

### How It Works

```
┌──────────┐    ┌──────────┐    ┌──────────┐    ┌───────────┐
│  Client  │───>│   Host   │───>│  Runner  │───>│    VPS    │
│  (CLI)   │ WS │  Proxy   │ WS │ (tunnel) │    │ Container │
└──────────┘    └──────────┘    └──────────┘    └───────────┘
```

Benefits:
- Full TTY support (vim, htop, nano work)
- No SSH server installation needed
- No Docker port mapping required
- Survives system restarts

### IDE Mode

Open a VSCode-like TUI interface:

```bash
kohakuriver connect <task_id> --ide
```

Features:
- File tree navigation
- Code editor
- Integrated terminal panel

Exit with Ctrl+Q.

---

## SSH Proxy

For traditional SSH access, KohakuRiver provides a transparent SSH proxy through the Host server:

```
┌──────────┐    ┌──────────┐    ┌──────────┐    ┌───────────┐
│  Client  │───>│   Host   │───>│  Runner  │───>│    VPS    │
│  (you)   │    │  Proxy   │    │ (node)   │    │ Container │
└──────────┘    └──────────┘    └──────────┘    └───────────┘
    :8002          :8002           :random         :22
```

**Requirement**: SSH server must be installed in the container.

Benefits:
- Single entry point (Host)
- No need to know Runner IPs
- No need to track dynamic ports

---

## Quick Connect

### Using vps connect

```bash
kohakuriver vps connect <task_id>
```

This handles everything automatically:
1. Looks up VPS connection info
2. Establishes proxy tunnel
3. Runs SSH with correct parameters

### Example

```bash
# List your VPS to get Task ID
kohakuriver vps list

# Connect
kohakuriver vps connect 7323718749301768192
```

---

## Connection Options

### Custom SSH Key

```bash
kohakuriver vps connect <task_id> --key ~/.ssh/my_vps_key
```

### Common SSH Flags

The connect command passes through to the system SSH client, supporting standard options:

```bash
# Port forwarding
kohakuriver vps connect <task_id> -- -L 8888:localhost:8888

# X11 forwarding
kohakuriver vps connect <task_id> -- -X
```

---

## Manual Connection

If you know the Runner node and port:

```bash
# Get VPS details
kohakuriver vps status <task_id>
# Note the "Node" and "SSH Port"

# Connect directly
ssh -p <port> root@<runner_hostname>
```

---

## Using SSH Config

Add entries to `~/.ssh/config` for frequently used VPS:

```ssh-config
Host myvps
    HostName <runner_hostname>
    Port <ssh_port>
    User root
    IdentityFile ~/.ssh/my_vps_key
```

Then connect with:

```bash
ssh myvps
```

**Note:** This requires knowing the specific port, which is dynamic.

---

## Troubleshooting

### Connection Refused

| Cause | Solution |
|-------|----------|
| VPS not running | Check `kohakuriver vps status <id>` |
| Wrong Task ID | Verify with `kohakuriver vps list` |
| Firewall blocking | Check port 8002 is accessible on Host |

### Authentication Failed

| Cause | Solution |
|-------|----------|
| Wrong key | Verify key matches what was used at creation |
| Key permissions | Run `chmod 600 ~/.ssh/your_key` |
| Root login disabled | Check container's sshd_config |

### Timeout Issues

| Cause | Solution |
|-------|----------|
| Host unreachable | Check network to Host server |
| Runner offline | Verify with `kohakuriver node list` |
| Container crashed | Try `kohakuriver vps restart <id>` |

### Debug Commands

```bash
# Check VPS status
kohakuriver vps status <task_id>

# Check Runner is online
kohakuriver node list

# View Host logs (on Host server)
journalctl -u kohakuriver-host -f

# View Runner logs (on Runner node)
journalctl -u kohakuriver-runner -f
```

---

## Security Considerations

| Practice | Description |
|----------|-------------|
| **Use SSH keys only** | Never enable password auth |
| **Restrict proxy access** | Firewall port 8002 to trusted networks |
| **Generate unique keys** | Use `--gen-ssh-key` for each VPS |
| **Monitor sessions** | Check active VPS regularly |

See [Security Guide](../../2.%20admin-guides/5.%20security.md) for comprehensive security recommendations.

---

## Disconnecting

- **WebSocket Terminal**: Type `exit` or press Ctrl+D
- **IDE Mode**: Press Ctrl+Q
- **SSH**: Type `exit` or close the session

The VPS container continues running until explicitly stopped.

---

## Port Forwarding

Access services running inside your VPS container:

### Basic Usage

```bash
# Forward Jupyter (port 8888)
kohakuriver forward <task_id> 8888

# Access at http://localhost:8888
```

### Custom Local Port

```bash
# Forward container port 80 to local port 3000
kohakuriver forward <task_id> 80 --local-port 3000
```

### UDP Forwarding

```bash
kohakuriver forward <task_id> 5353 --proto udp
```

### How It Works

```
Local TCP/UDP --> CLI --WebSocket--> Host --> Runner --> Container Service
```

Benefits:
- No Docker port mapping required
- Multiple containers can use the same port (no conflicts)
- Works after container restarts

Press Ctrl+C to stop forwarding.

---

## Next Steps

1. [Container preparation for VPS](3.%20container-prep.md)
2. [Common use cases](4.%20common-use-cases.md)
