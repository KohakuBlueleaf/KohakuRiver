# VPS Task Management Guide

VPS tasks launch persistent, interactive Docker containers - like on-demand virtual private servers on your cluster nodes. They are ideal for R&D workflows where you can't create a complete Docker image upfront and need to iterate on your environment.

---

## Overview

### What is a VPS Task?

A VPS task is a running Docker container with multiple access methods:

| Characteristic | Description |
|----------------|-------------|
| **Persistent** | Runs until explicitly stopped, survives system restarts |
| **Interactive** | Multiple access methods (SSH, WebSocket terminal, IDE mode) |
| **Key-based auth** | SSH uses public keys |
| **No Port Mapping Needed** | WebSocket terminal and port forwarding work without Docker port mapping |

### Access Methods

| Method | Command | Requirements |
|--------|---------|--------------|
| **SSH** | `kohakuriver vps connect <id>` | SSH server installed in container |
| **WebSocket Terminal** | `kohakuriver connect <id>` | None (full TTY support) |
| **IDE Mode** | `kohakuriver connect <id> --ide` | None (file tree + terminal) |
| **Port Forwarding** | `kohakuriver forward <id> <port>` | Service running in container |

---

## CLI Commands

```bash
kohakuriver vps list              # List VPS instances
kohakuriver vps status <id>       # Detailed status
kohakuriver vps create            # Create new VPS
kohakuriver vps connect <id>      # SSH connect to VPS
kohakuriver vps stop <id>         # Stop VPS
kohakuriver vps restart <id>      # Restart VPS
kohakuriver vps pause <id>        # Pause VPS
kohakuriver vps resume <id>       # Resume paused VPS
```

---

## Creating a VPS

### Basic Usage

```bash
kohakuriver vps create [OPTIONS]
```

### SSH Key Options

| Option | Description |
|--------|-------------|
| (default) | Use `~/.ssh/id_ed25519.pub` or `~/.ssh/id_rsa.pub` |
| `--public-key-file PATH` | Use specific public key file |
| `--public-key-string KEY` | Provide key as string |
| `--gen-ssh-key` | Generate new keypair |
| `--no-ssh-key` | Passwordless root login |

### Resource Options

| Option | Short | Description |
|--------|-------|-------------|
| `--target` | `-t` | Target node[:numa][::gpus] |
| `--cores` | `-c` | CPU cores (default: 1) |
| `--memory` | `-m` | Memory limit (e.g., 4G) |
| `--container` | | Container environment name |
| `--privileged` | | Run with Docker --privileged |
| `--mount` | | Additional mounts (repeatable) |

### Examples

**Basic VPS with auto-select:**

```bash
kohakuriver vps create --cores 2 --memory 4G
```

Uses default SSH key and lets Host select a suitable node.

**Target specific node:**

```bash
kohakuriver vps create -t nodeA --cores 4 --container my-dev-env
```

**GPU VPS:**

```bash
kohakuriver vps create -t nodeC::0,1 --cores 8 --memory 16G --container my-cuda-vps
```

**Generate new SSH key:**

```bash
kohakuriver vps create --gen-ssh-key --key-out-file ~/.ssh/vps_key
```

Generates a new keypair and saves it to the specified path.

---

## Connecting to VPS

### Method 1: WebSocket Terminal (Recommended)

No SSH server required, full TTY support:

```bash
kohakuriver connect <task_id>
```

This provides:
- Full TTY support (vim, htop, nano, screen work)
- No Docker port mapping needed
- Works even after system restarts

Exit with `exit` or Ctrl+D.

### Method 2: IDE Mode

VSCode-like TUI with file tree and integrated terminal:

```bash
kohakuriver connect <task_id> --ide
```

Exit with Ctrl+Q.

### Method 3: SSH (via Proxy)

Requires SSH server installed in container:

```bash
kohakuriver vps connect <task_id>
```

This automatically:
1. Looks up VPS connection info
2. Connects through the SSH proxy
3. Uses the appropriate SSH key

With custom key:

```bash
kohakuriver vps connect <task_id> --key ~/.ssh/custom_key
```

### Method 4: Port Forwarding

Access services running in the container:

```bash
# Forward Jupyter on port 8888
kohakuriver forward <task_id> 8888

# Forward with custom local port
kohakuriver forward <task_id> 80 --local-port 3000
```

### Manual SSH (Direct)

If you know the node and port:

```bash
ssh -p <port> root@<runner_node>
```

---

## Listing VPS Instances

### Active VPS Only

```bash
kohakuriver vps list
```

Shows: Task ID, Status, Node, Resources, SSH Port

### Include Stopped

```bash
kohakuriver vps list --all
```

---

## Managing VPS Lifecycle

### Check Status

```bash
kohakuriver vps status <task_id>
```

Shows detailed information including:
- Container name
- Assigned node
- SSH port
- Resources allocated
- Timestamps

### Stop VPS

```bash
kohakuriver vps stop <task_id>
```

Terminates the VPS container.

### Restart VPS

```bash
kohakuriver vps restart <task_id>
```

Useful when:
- NVIDIA docker breaks (nvml error)
- Container becomes unresponsive
- Need to apply configuration changes

### Pause/Resume

```bash
kohakuriver vps pause <task_id>
kohakuriver vps resume <task_id>
```

Pausing suspends the container without stopping it.

---

## SSH Key Management

### Default Keys

KohakuRiver checks these locations automatically:
1. `~/.ssh/id_ed25519.pub`
2. `~/.ssh/id_rsa.pub`

### Generated Keys

When using `--gen-ssh-key`:

```bash
kohakuriver vps create --gen-ssh-key
```

Keys are saved to:
- Private: `~/.ssh/kohakuriver_vps_<task_id>`
- Public: `~/.ssh/kohakuriver_vps_<task_id>.pub`

Custom output path:

```bash
kohakuriver vps create --gen-ssh-key --key-out-file ~/.ssh/my_vps
```

---

## VPS Lifecycle States

```
┌─────────┐    ┌───────────┐    ┌─────────┐
│ PENDING │───>│ ASSIGNING │───>│ RUNNING │
└─────────┘    └───────────┘    └─────────┘
                                     │
                    ┌────────────────┼────────────────┐
                    ▼                ▼                ▼
               ┌─────────┐    ┌─────────┐    ┌─────────┐
               │ PAUSED  │    │ STOPPED │    │  LOST   │
               └─────────┘    └─────────┘    └─────────┘
```

| Status | Description |
|--------|-------------|
| `pending` | Waiting to be assigned |
| `assigning` | Being assigned to Runner |
| `running` | Active and accessible via SSH |
| `paused` | Container paused |
| `stopped` | Terminated by user |
| `lost` | Runner lost contact |

---

## Best Practices

| Practice | Description |
|----------|-------------|
| **Use dedicated keys** | Generate keys per VPS for security |
| **Set resource limits** | Always specify `--cores` and `--memory` |
| **Stop when done** | Free resources for other users |
| **Use prepared images** | Ensure container has SSH server |

---

## Next Steps

1. [SSH access details](2.%20ssh-access.md)
2. [Container preparation for VPS](3.%20container-prep.md)
3. [Common use cases](4.%20common-use-cases.md)
