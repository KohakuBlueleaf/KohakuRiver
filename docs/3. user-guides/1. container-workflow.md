# Docker Container Workflow Guide

This guide explains how to create, customize, and manage Docker containers in KohakuRiver to provide consistent environments for your tasks.

---

## Overview

### The Container Workflow

KohakuRiver treats Docker containers as portable, reproducible environments:

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   CREATE    │───>│  CUSTOMIZE  │───>│   PACKAGE   │───>│ DISTRIBUTE  │
│  Container  │    │  Install SW │    │   Tarball   │    │  to Runners │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
```

| Step | Description |
|------|-------------|
| **Create** | Start a persistent container on the Host |
| **Customize** | Install software via interactive shell |
| **Package** | Create tarball for distribution |
| **Distribute** | Runners auto-sync when tasks are submitted |

---

## CLI Commands

### Container Management

```bash
kohakuriver docker container list          # List containers on Host
kohakuriver docker container create        # Create a new container
kohakuriver docker container shell         # Interactive shell into container
kohakuriver docker container start         # Start a stopped container
kohakuriver docker container stop          # Stop a running container
kohakuriver docker container delete        # Delete a container
```

### Tarball Management

```bash
kohakuriver docker tar list                # List available tarballs
kohakuriver docker tar create              # Create tarball from container
kohakuriver docker tar delete              # Delete a tarball
```

---

## Creating a Container

### Basic Usage

```bash
kohakuriver docker container create <base-image> <container-name>
```

| Parameter | Description |
|-----------|-------------|
| `<base-image>` | Docker image from registry (e.g., `python:3.11-slim`) |
| `<container-name>` | Name for this environment (e.g., `my-python-env`) |

### Examples

```bash
# Lightweight Python environment
kohakuriver docker container create python:3.11-slim my-python-env

# GPU-ready CUDA environment
kohakuriver docker container create nvidia/cuda:11.8.0-cudnn8-runtime-ubuntu22.04 my-cuda-env

# General Ubuntu environment
kohakuriver docker container create ubuntu:22.04 my-ubuntu-base
```

---

## Customizing Your Environment

### Get Interactive Shell

```bash
kohakuriver docker container shell <container-name>
```

This opens a shell session inside the container on the Host.

### Install Software

**Debian/Ubuntu-based images:**

```bash
apt-get update
apt-get install -y build-essential git htop
pip install numpy pandas matplotlib scikit-learn torch
```

**Alpine-based images:**

```bash
apk update
apk add --no-cache build-base git htop
pip install numpy pandas
```

Type `exit` when finished.

### Preparing for VPS Tasks

For VPS tasks, install and configure SSH server:

```bash
# Get shell
kohakuriver docker container shell my-ubuntu-base

# Inside container:
apt-get update
apt-get install -y openssh-server
mkdir -p /run/sshd

# Ensure root login is enabled (KohakuRiver injects keys to root)
# Edit /etc/ssh/sshd_config if needed:
# PermitRootLogin yes

exit
```

---

## Packaging the Environment

### Create Tarball

```bash
kohakuriver docker tar create <container-name>
```

This:
1. Stops the container temporarily
2. Commits current state to a Docker image
3. Saves to `<container-name>-<timestamp>.tar` in shared storage
4. Removes older tarballs for the same container name
5. Restarts the container

### Example

```bash
kohakuriver docker tar create my-python-env
```

Creates: `kohakuriver-containers/my-python-env-1700000000.tar`

---

## Managing Containers

### List Containers

```bash
kohakuriver docker container list
```

Shows Docker ID, Name, Image, and Status.

### Start/Stop

```bash
kohakuriver docker container stop my-python-env
kohakuriver docker container start my-python-env
```

### Delete

```bash
kohakuriver docker container delete my-python-env
```

**Note:** Deleting a container doesn't remove existing tarballs.

---

## Managing Tarballs

### List Available

```bash
kohakuriver docker tar list
```

### Delete Tarball

```bash
kohakuriver docker tar delete my-python-env-1700000000.tar
```

### Automatic Cleanup

When creating a new tarball, older tarballs with the same container name prefix are automatically removed.

---

## Runner Synchronization

When a task is submitted:

1. Runner checks for local Docker image
2. Compares timestamp with latest tarball in shared storage
3. If outdated or missing, downloads and loads the tarball
4. Executes task with the latest image

This is **automatic** - no manual intervention required.

---

## Best Practices

| Practice | Description |
|----------|-------------|
| **Descriptive names** | Use clear names like `python-3.9-ml`, `cuda-11.8-tf` |
| **Minimize size** | Use slim/alpine images, clean caches after installing |
| **Test before packaging** | Verify environment works before creating tarball |
| **Update workflow** | Shell → modify → exit → create tarball |

### Minimizing Image Size

```bash
# Inside container:
apt-get update && apt-get install -y --no-install-recommends build-essential
apt-get clean
rm -rf /var/lib/apt/lists/*
```

---

## Example Workflow

### Data Science Environment

```bash
# 1. Create container
kohakuriver docker container create python:3.9-slim python-data-science

# 2. Customize
kohakuriver docker container shell python-data-science
# Inside container:
# apt-get update && apt-get install -y build-essential
# pip install numpy pandas matplotlib seaborn scikit-learn
# exit

# 3. Package
kohakuriver docker tar create python-data-science

# 4. Use in tasks
kohakuriver task submit "python /shared/analyze.py" -t nodeA --container python-data-science
```

---

## Next Steps

1. [Submit command tasks](2.%20command-tasks/1.%20submission.md)
2. [Create VPS sessions](3.%20vps-tasks/1.%20management.md)
3. [Configure GPU allocation](4.%20gpu-allocation/1.%20allocation.md)
