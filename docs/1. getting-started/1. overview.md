# KohakuRiver Overview

## What is KohakuRiver?

KohakuRiver is a lightweight, self-hosted cluster manager designed for distributing command-line tasks and launching persistent interactive sessions (**VPS Tasks**) across multiple compute nodes. It provides a simple yet powerful solution for research labs, small teams, and home labs that need to efficiently utilize a modest number of machines (typically 3-10 nodes), using **Docker containers as reproducible environments**.

## The Problem KohakuRiver Solves

Small to medium research teams often find themselves in an awkward middle ground:

| Challenge | Description |
|-----------|-------------|
| **Too many machines** | Manual SSH and shell scripts become unmanageable |
| **Too few machines** | Complex HPC schedulers like Slurm are overkill |
| **Wrong tool** | Kubernetes is designed for services, not batch tasks |

You have powerful compute resources but lack an efficient way to utilize them as a unified computing resource without significant operational overhead.

## Core Concept: Your Nodes as One Big Computer

KohakuRiver addresses this by treating your small cluster as a single powerful computer:

- **Lightweight Resource Management** - Distribute tasks and VPS sessions with minimal setup
- **Environment Consistency** - Docker containers ensure identical execution environments
- **Seamless Synchronization** - Container environments auto-distribute to runners
- **Familiar Workflow** - Submit tasks like running local commands

> **Key Insight**: Docker in KohakuRiver functions like a portable virtual environment (similar to Python's venv or conda) that auto-syncs across nodes.

---

## Architecture

```
┌─────────────────────────────────────────────────────────────┐
│  Clients: CLI (kohakuriver) / Web Dashboard                 │
└──────────────────────────┬──────────────────────────────────┘
                           │
┌──────────────────────────▼──────────────────────────────────┐
│  HOST SERVER (kohakuriver.host)                             │
│  - Task scheduling and dispatch                             │
│  - Node registration and health monitoring                  │
│  - Docker environment management                            │
│  - SSH proxy for VPS access                                 │
│  - SQLite database for state                                │
└──────────────────────────┬──────────────────────────────────┘
                           │
         ┌─────────────────┼─────────────────┐
         ▼                 ▼                 ▼
┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│  RUNNER 1       │ │  RUNNER 2       │ │  RUNNER N       │
│  (kohakuriver.  │ │  (kohakuriver.  │ │  (kohakuriver.  │
│   runner)       │ │   runner)       │ │   runner)       │
│  - Task exec    │ │  - Task exec    │ │  - Task exec    │
│  - VPS mgmt     │ │  - VPS mgmt     │ │  - VPS mgmt     │
│  - Resource mon │ │  - Resource mon │ │  - Resource mon │
└─────────────────┘ └─────────────────┘ └─────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  SHARED STORAGE (/mnt/cluster-share)                        │
│  - kohakuriver-containers/  (Docker tarballs)               │
│  - shared_data/             (Mounted as /shared in tasks)   │
└─────────────────────────────────────────────────────────────┘
```

---

## System Components

### Host Server (`kohakuriver.host`)

The central coordinator that manages the entire cluster:

- Manages nodes and tasks in SQLite database
- Provides REST API for task submission and monitoring
- Manages Docker environments and tarballs on shared storage
- Runs SSH proxy server for VPS task access
- Serves the optional web dashboard

### Runner Agents (`kohakuriver.runner`)

Agents running on each compute node:

- Execute tasks within Docker containers
- Automatically sync container environments from shared storage
- Report resource usage (CPU, memory, GPU, temperature) to Host
- Handle task lifecycle (start, pause, resume, kill)

### CLI Tool (`kohakuriver`)

Unified command-line interface with subcommands:

| Command | Description |
|---------|-------------|
| `kohakuriver task` | Task management (submit, list, status, kill, pause, resume) |
| `kohakuriver vps` | VPS management (create, list, stop, connect, restart) |
| `kohakuriver node` | Node management (list) |
| `kohakuriver docker` | Docker/container management |
| `kohakuriver connect` | WebSocket terminal to tasks (full TTY, IDE mode) |
| `kohakuriver forward` | Port forwarding to container services (TCP/UDP) |
| `kohakuriver terminal` | Terminal TUI dashboard |
| `kohakuriver init` | Initialize config and systemd services |
| `kohakuriver config` | Configuration management |
| `kohakuriver status` | Quick cluster status overview |

### Web Dashboard (Optional)

Visual interface providing:

- Cluster overview with node status and resource utilization
- Task submission with target selection and resource configuration
- VPS creation with SSH key management
- Docker environment management
- GPU utilization monitoring
- Web-based terminal access

---

## Key Features

### Task Execution

| Feature | Description |
|---------|-------------|
| **Command Tasks** | One-shot command execution in Docker containers |
| **VPS Tasks** | Persistent containers with SSH access - ideal for R&D workflows |
| **Multi-Target** | Submit same task to multiple nodes simultaneously |
| **Resource Limits** | Specify CPU cores, memory, and GPU requirements |

### Environment Management

| Feature | Description |
|---------|-------------|
| **Docker Workflow** | Create, customize, and package environments |
| **Auto-Sync** | Runners automatically fetch required tarballs |
| **Versioned Tarballs** | Timestamped environment snapshots |
| **Interactive Setup** | Shell access to customize containers |

### Resource Management

| Feature | Description |
|---------|-------------|
| **CPU/Memory Allocation** | Request specific resource limits |
| **GPU Allocation** | Request specific GPU devices |
| **NUMA Targeting** | Bind tasks to NUMA nodes |
| **Health Monitoring** | Track node status and resource usage |

### Access & Connectivity (Without Docker Port Mapping)

| Feature | Description |
|---------|-------------|
| **TTY Forwarding** | WebSocket terminal (`kohakuriver connect`) with full TTY support (vim, htop) |
| **Port Forwarding** | Dynamic TCP/UDP tunneling (`kohakuriver forward`) to container services |
| **SSH Proxy** | Connect to VPS through Host relay (`kohakuriver vps connect`) |
| **Terminal TUI** | Full-screen dashboard (`kohakuriver terminal`) with keyboard navigation |
| **IDE Mode** | TUI IDE (`kohakuriver connect --ide`) with file tree and terminal |
| **Task Control** | Pause, resume, and kill tasks |

> **Key Benefit**: TTY and port forwarding work without Docker port mapping, allowing long-running containers to survive system restarts and avoiding port conflicts on runner nodes.

---

## When to Use KohakuRiver

**Ideal for:**

- Research labs with multiple computers for data processing, simulations, or analysis
- Small teams distributing computational tasks across available machines
- Home lab setups wanting to utilize all machines efficiently
- Development environments requiring reproducibility

**Best suited for:**

- Command-line batch processing
- Machine learning training jobs
- Data processing pipelines
- Interactive development environments (VPS)
- Parameter sweep experiments

---

## What KohakuRiver Is NOT

| Not For | Use Instead |
|---------|-------------|
| Large-scale HPC clusters (100+ nodes) | Slurm, PBS, LSF |
| Microservices orchestration | Kubernetes, Docker Swarm |
| Complex workflow DAGs | Airflow, Prefect, Nextflow |
| Multi-tenant production services | Kubernetes with RBAC |
| High-availability requirements | Kubernetes, Nomad |

---

## Next Steps

- [Installation Guide](2.%20installation.md) - Install KohakuRiver
- [Quick Start Guide](3.%20quick-start.md) - Get running quickly
- [Core Concepts](4.%20concepts.md) - Understand key concepts
- [Alternatives Comparison](5.%20alternatives.md) - Compare with other tools
