# Quick Start Guide

This guide will walk you through setting up a basic KohakuRiver cluster and running your first tasks. By the end, you'll have:

1. A running Host server
2. One or more Runner nodes connected to the Host
3. A Docker environment ready for tasks
4. Experience submitting both Command tasks and VPS tasks

## Prerequisites

Before starting, ensure you have:
- KohakuRiver installed on all machines (see [Installation Guide](2.%20installation.md))
- Docker running on Host and Runner nodes
- Shared storage mounted at the same path on all nodes
- Network connectivity between all machines

## Step 1: Configure KohakuRiver

Generate configuration files on each machine:

```bash
kohakuriver init config --all
```

Edit the configuration files:

**On the Host machine** (`~/.kohakuriver/host_config.py`):
```python
HOST_REACHABLE_ADDRESS: str = "192.168.1.100"  # Your Host's IP
SHARED_DIR: str = "/mnt/cluster-share"          # Your shared storage path
```

**On each Runner node** (`~/.kohakuriver/runner_config.py`):
```python
HOST_ADDRESS: str = "192.168.1.100"  # Same as HOST_REACHABLE_ADDRESS above
SHARED_DIR: str = "/mnt/cluster-share"  # Same path as Host
```

## Step 2: Start the Host Server

On your designated Host machine:

```bash
kohakuriver.host
```

Or set up as a systemd service for production use:

```bash
kohakuriver init service --host
sudo systemctl start kohakuriver-host
sudo systemctl enable kohakuriver-host
```

The Host should now be listening on port 8000.

## Step 3: Start Runner Agents

On each compute node you want to use:

```bash
kohakuriver.runner
```

Or as a systemd service:

```bash
kohakuriver init service --runner
sudo systemctl start kohakuriver-runner
sudo systemctl enable kohakuriver-runner
```

## Step 4: Verify the Cluster

Check that all nodes are connected:

```bash
kohakuriver node list
```

You should see all your Runner nodes listed with status "online". If a node is offline, check its configuration, network connectivity to the Host, and the Runner's logs.

## Step 5: Create a Docker Environment

KohakuRiver uses Docker containers as portable environments. Let's create one:

### Create a Container from a Base Image

```bash
kohakuriver docker container create ubuntu:22.04 my-ubuntu-env
```

### Install Software Interactively

Get a shell into the container to install packages:

```bash
kohakuriver docker container shell my-ubuntu-env
```

Inside the container:
```bash
apt update && apt install -y python3 python3-pip
pip3 install numpy pandas
exit
```

### Package as a Tarball

Create a tarball for distribution to Runner nodes:

```bash
kohakuriver docker tar create my-ubuntu-env
```

Verify the tarball was created:

```bash
kohakuriver docker tar list
```

## Step 6: Submit Your First Command Task

Now let's run some tasks on the cluster.

### Simple Echo Task

Submit a basic echo command to a node:

```bash
kohakuriver task submit 'echo "Hello, KohakuRiver!"' -t node1
```

### Task with Custom Environment

Use your custom environment with resource limits:

```bash
kohakuriver task submit 'python3 -c "print(\"Hello from custom env!\")"' -t node1 -c 2 -m 4G --container my-ubuntu-env
```

### Multi-Target Task

Submit the same task to multiple nodes:

```bash
kohakuriver task submit 'hostname' -t node1 -t node2 -t node3
```

### GPU Task

If your nodes have GPUs:

```bash
kohakuriver task submit 'nvidia-smi' -t node1::0,1 --container my-cuda-env
```

## Step 7: Monitor Tasks

### List All Tasks

```bash
kohakuriver task list
```

### Get Task Status

```bash
kohakuriver task status <task_id>
```

### Task Control

```bash
# Pause a running task
kohakuriver task pause <task_id>

# Resume a paused task
kohakuriver task resume <task_id>

# Kill a task
kohakuriver task kill <task_id>
```

## Step 8: Create a VPS Instance

VPS tasks provide persistent interactive containers - ideal for R&D workflows where you need to iterate on your environment.

### Create a VPS

```bash
# Create VPS with 4 cores and 8GB memory
kohakuriver vps create -t node1 -c 4 -m 8G --container my-ubuntu-env
```

### Connect via SSH (requires SSH server in container)

```bash
kohakuriver vps connect <vps_task_id>
```

### Connect via WebSocket Terminal (no Docker port mapping needed)

```bash
kohakuriver connect <vps_task_id>
```

This provides full TTY support for vim, htop, and other TUI applications.

### Open TUI IDE Mode

```bash
kohakuriver connect <vps_task_id> --ide
```

Opens a VSCode-like interface with file tree and integrated terminal.

### List VPS Instances

```bash
kohakuriver vps list
```

### Stop a VPS

```bash
kohakuriver vps stop <vps_task_id>
```

## Step 9: Forward Ports to Container Services

Access services running inside containers without Docker port mapping:

### Forward a Port

```bash
# Forward Jupyter (port 8888) to local machine
kohakuriver forward <task_id> 8888

# Access at http://localhost:8888
```

### Custom Local Port

```bash
# Forward container port 80 to local port 3000
kohakuriver forward <task_id> 80 --local-port 3000
```

### UDP Forwarding

```bash
kohakuriver forward <task_id> 5353 --proto udp
```

## Step 10: Use Terminal TUI Dashboard

Launch the full-screen terminal dashboard:

```bash
kohakuriver terminal
```

Navigate with keyboard:
- `1` - Dashboard overview
- `2` - Nodes view
- `3` - Tasks view
- `4` - VPS view
- `q` - Quit

## Step 11: Using the Web Dashboard

KohakuRiver includes a web dashboard for visual management.

### Start the Dashboard

```bash
cd src/kohakuriver-manager
npm install
npm run dev
```

The dashboard provides:
- **Overview**: Cluster status and resource utilization
- **Tasks**: Submit, monitor, and control command tasks
- **VPS**: Create and manage VPS instances
- **Docker**: Manage containers and tarballs
- **Nodes**: View node status and GPU info

## Next Steps

Now that you have a working cluster, explore these topics:

- [Container Workflow](../3.%20user-guides/1.%20container-workflow.md) - Advanced environment management
- [Command Tasks](../3.%20user-guides/2.%20command-tasks/1.%20submission.md) - Detailed task submission options
- [VPS Tasks](../3.%20user-guides/3.%20vps-tasks/1.%20management.md) - VPS configuration and SSH access
- [GPU Allocation](../3.%20user-guides/4.%20gpu-allocation/1.%20allocation.md) - Using GPUs in tasks
- [Configuration Reference](../4.%20reference/1.%20configuration.md) - All configuration options

## Troubleshooting

### Node Not Showing as Online

1. Check Runner is running: `systemctl status kohakuriver-runner`
2. Verify `HOST_ADDRESS` in runner config matches Host's actual IP
3. Check network connectivity: `curl http://HOST_IP:8000/health`
4. Check Runner logs: `journalctl -u kohakuriver-runner -f`

### Task Fails to Start

1. Verify the container tarball exists: `kohakuriver docker tar list`
2. Check Docker is running on the Runner: `docker info`
3. Verify shared storage is accessible: `ls /mnt/cluster-share/kohakuriver-containers/`

### VPS SSH Connection Fails

1. Ensure the VPS container has SSH server installed
2. Verify the VPS is running: `kohakuriver vps list`
3. Check the SSH proxy port (8002) is accessible

For more help, see the [Troubleshooting Guide](../5.%20troubleshooting/1.%20troubleshooting.md).
