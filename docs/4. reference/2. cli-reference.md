# CLI Reference

Complete command reference for `kohakuriver` CLI.

---

## Global Structure

```
kohakuriver <subcommand> [options]
```

| Subcommand | Description |
|------------|-------------|
| `init` | Initialize configs and services |
| `status` | Quick cluster overview |
| `node` | Node management |
| `task` | Task management |
| `vps` | VPS management |
| `docker` | Container management |
| `connect` | WebSocket terminal (full TTY, IDE mode) |
| `forward` | Port forwarding to container services |
| `terminal` | Terminal TUI dashboard |
| `config` | Configuration management |

---

## init

```bash
kohakuriver init config [--client] [--host] [--runner] [--all]
kohakuriver init service [--host] [--runner] [--all] [--no-install]
```

| Option | Description |
|--------|-------------|
| `--client` | Generate client config |
| `--host` | Generate host config/service |
| `--runner` | Generate runner config/service |
| `--all` | Generate all |
| `--no-install` | Don't register systemd service |

---

## node

```bash
kohakuriver node list
```

Lists all registered nodes with status, cores, memory, GPUs.

---

## task

### List Tasks

```bash
kohakuriver task list [OPTIONS]
```

| Option | Description |
|--------|-------------|
| `-s, --status` | Filter by status |
| `-n, --node` | Filter by node |
| `-l, --limit` | Max results (default: 50) |
| `-c, --compact` | Compact output |

### Submit Task

```bash
kohakuriver task submit <command> [args...] [OPTIONS]
```

| Option | Description |
|--------|-------------|
| `-t, --target` | Target node[:numa][::gpus] (repeatable) |
| `-c, --cores` | CPU cores (default: 1) |
| `-m, --memory` | Memory limit (e.g., 4G) |
| `--container` | Container environment |
| `--privileged` | Docker privileged mode |
| `--mount` | Additional mounts (repeatable) |
| `-w, --wait` | Wait for completion |

### Task Operations

```bash
kohakuriver task status <task_id>    # Detailed status
kohakuriver task logs <task_id>      # View output
kohakuriver task watch <task_id>     # Stream output
kohakuriver task kill <task_id>      # Terminate
kohakuriver task pause <task_id>     # Pause
kohakuriver task resume <task_id>    # Resume
```

---

## vps

### List VPS

```bash
kohakuriver vps list [--all]
```

| Option | Description |
|--------|-------------|
| `-a, --all` | Include stopped VPS |

### Create VPS

```bash
kohakuriver vps create [OPTIONS]
```

| Option | Description |
|--------|-------------|
| `-t, --target` | Target node[:numa][::gpus] |
| `-c, --cores` | CPU cores (default: 1) |
| `-m, --memory` | Memory limit |
| `--container` | Container environment |
| `--public-key-file` | SSH public key file |
| `--public-key-string` | SSH public key string |
| `--gen-ssh-key` | Generate new keypair |
| `--no-ssh-key` | Passwordless root |
| `--key-out-file` | Output path for generated key |
| `--privileged` | Docker privileged mode |
| `--mount` | Additional mounts |

### VPS Operations

```bash
kohakuriver vps status <task_id>     # Detailed status
kohakuriver vps connect <task_id>    # SSH connect
kohakuriver vps stop <task_id>       # Stop VPS
kohakuriver vps restart <task_id>    # Restart VPS
kohakuriver vps pause <task_id>      # Pause
kohakuriver vps resume <task_id>     # Resume
```

---

## docker

### Container Management

```bash
kohakuriver docker container list
kohakuriver docker container create <image> <name>
kohakuriver docker container shell <name>
kohakuriver docker container start <name>
kohakuriver docker container stop <name>
kohakuriver docker container delete <name>
```

### Tarball Management

```bash
kohakuriver docker tar list
kohakuriver docker tar create <container_name>
kohakuriver docker tar delete <tarball_name>
```

---

## connect

WebSocket terminal connection with full TTY support.

```bash
kohakuriver connect <task_id> [OPTIONS]
```

| Option | Description |
|--------|-------------|
| `--ide`, `-i` | Open TUI IDE with file tree, editor, and terminal |

### Examples

```bash
# Terminal mode (default) - full TTY support
kohakuriver connect 12345678901234567

# IDE mode - file tree + terminal
kohakuriver connect 12345678901234567 --ide
```

### Keyboard Shortcuts

**Terminal Mode:**
- `exit` or Ctrl+D - Exit terminal

**IDE Mode:**
- Ctrl+Q - Exit IDE

---

## forward

Port forwarding to container services via tunnel proxy.

```bash
kohakuriver forward <task_id> <remote_port> [OPTIONS]
```

| Option | Short | Description |
|--------|-------|-------------|
| `--local-port` | `-l` | Local port to listen on (default: same as remote) |
| `--local-host` | `-H` | Local address to bind to (default: 127.0.0.1) |
| `--proto` | `-p` | Protocol: tcp or udp (default: tcp) |

### Examples

```bash
# Forward port 8888 (Jupyter)
kohakuriver forward 12345678901234567 8888

# Forward container port 80 to local port 3000
kohakuriver forward 12345678901234567 80 --local-port 3000

# Forward UDP traffic
kohakuriver forward 12345678901234567 5353 --proto udp

# Listen on all interfaces
kohakuriver forward 12345678901234567 8080 --local-host 0.0.0.0
```

### How It Works

Creates a local TCP/UDP server that forwards connections through the KohakuRiver tunnel system:

```
Local connections → CLI → WebSocket → Host → Runner → Container service
```

Press Ctrl+C to stop forwarding.

---

## terminal

Full-screen Terminal TUI dashboard.

```bash
kohakuriver terminal [OPTIONS]
```

| Option | Short | Description |
|--------|-------|-------------|
| `--host` | `-H` | Host address |
| `--port` | `-P` | Host port |
| `--refresh` | `-r` | Refresh rate in seconds (default: 2.0) |

### Keyboard Navigation

| Key | Action |
|-----|--------|
| `1` | Dashboard view |
| `2` | Nodes view |
| `3` | Tasks view |
| `4` | VPS view |
| `f` | Filter tasks (in Tasks view) |
| `r` | Refresh data |
| `q` | Quit |

### Subcommands

```bash
kohakuriver terminal attach <task_id>     # Attach to container (via docker exec)
kohakuriver terminal exec <task_id> CMD   # Execute command in container
```

---

## Target Syntax

```
HOST[:NUMA_ID][::GPU_ID1,GPU_ID2,...]
```

| Example | Description |
|---------|-------------|
| `node1` | Run on node1 |
| `node1:0` | Run on NUMA node 0 |
| `node1::0` | Run with GPU 0 |
| `node1::0,1` | Run with GPUs 0 and 1 |

---

## Memory Units

| Unit | Size |
|------|------|
| `K` | Kilobytes |
| `M` | Megabytes |
| `G` | Gigabytes |

Example: `--memory 4G`, `--memory 512M`
